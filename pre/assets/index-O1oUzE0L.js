import{J as Le,d as Pe,c as D,o as f,a as k,b as d,t as q,s as Ce,v as Z,_ as K,K as Ve,u as ze,r as b,L as Ee,w as ue,p as j,h as z,F as M,e as Y,k as T,m as ce,f as E,g as he,M as qe,l as pe,N as ve,n as Ae,C as J,O as Me,D as fe,P as We,q as me,Q as Be,i as Fe,S as ge,U as He,W as Xe,X as Ye,Y as Q,Z as Je,j as Qe,x as Ze,y as Ke}from"./index-CbusNKop.js";var et=Object.defineProperty,tt=(i,a,l)=>a in i?et(i,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):i[a]=l,R=(i,a,l)=>tt(i,typeof a!="symbol"?a+"":a,l),ye=(i,a,l)=>new Promise((v,u)=>{var m=n=>{try{P(l.next(n))}catch(h){u(h)}},_=n=>{try{P(l.throw(n))}catch(h){u(h)}},P=n=>n.done?v(n.value):Promise.resolve(n.value).then(m,_);P((l=l.apply(i,a)).next())});class st{constructor(a,l,v=4){this.runner=a,this.disposer=l,this.parallel=v,R(this,"state",Le({busy:!1,error:null,completed:0,fullCount:0})),R(this,"pendingData",[]),R(this,"currentlyRunning",new Set),R(this,"resolveCurrentRun",null),R(this,"rejectCurrentRun",null),R(this,"returnData",[]),R(this,"remainingDisposers",new Set),R(this,"runningDisposers",new Set)}run(a){return this.rejectCurrentRun&&this.reject(),a=a.slice(),this.pendingData=a,this.returnData=[],this.state.fullCount=a.length,this.state.error=null,this.state.busy=!0,this.state.completed=0,new Promise((l,v)=>{this.resolveCurrentRun=l,this.rejectCurrentRun=v,a.length>0?this.restock():this.resolve()})}get remainingCapacity(){return this.parallel-this.currentlyRunning.size-this.runningDisposers.size}restock(){for(;this.remainingCapacity>0&&this.pendingData.length>0;)this.startOne();for(;this.remainingCapacity>0&&this.remainingDisposers.size>0;)this.startDisposer()}startOne(){return ye(this,null,function*(){const a=this.pendingData.shift(),l=this.returnData.length;if(this.returnData[l]=void 0,a==null)return;this.currentlyRunning.add(a);const v=()=>this.currentlyRunning.has(a);let u;try{u=yield this.runner(a,v)}catch(m){this.reject(m)}v()?(++this.state.completed,this.returnData[l]=u,this.currentlyRunning.delete(a),this.currentlyRunning.size===0&&this.pendingData.length===0&&this.resolve()):u!==void 0&&this.remainingDisposers.add(u),this.restock()})}startDisposer(){return ye(this,null,function*(){const a=this.remainingDisposers.values().next().value;this.remainingDisposers.delete(a),this.runningDisposers.add(a);try{yield this.disposer(a)}catch(l){console.error(l)}this.runningDisposers.delete(a),this.restock()})}resolve(){this.state.busy=!1,this.state.completed=this.state.fullCount;const a=this.returnData,l=this.resolveCurrentRun;this.reset(),l(a)}reject(a){var l;this.state.busy=!1,this.state.error=(l=a==null?void 0:a.message)!=null?l:null;const v=this.returnData,u=this.rejectCurrentRun;this.reset();for(const m of v)m!==void 0&&this.remainingDisposers.add(m);u()}reset(){this.returnData=[],this.currentlyRunning=new Set,this.resolveCurrentRun=null,this.rejectCurrentRun=null}get busy(){return this.state.busy}get fullCount(){return this.state.fullCount}get completed(){return this.state.completed}get percentage(){return this.fullCount===0?0:this.completed/this.fullCount}get error(){return this.state.error}}const at={class:"icon material-icons"},nt={class:"label"},lt=Pe({__name:"selection",props:{icon:String,label:String,images:{default:[]}},setup(i){const a=i,l=D(()=>a.images.map(v=>`center / contain no-repeat url('${v}')`).join(","));return(v,u)=>(f(),k("div",{class:"selection",style:Ce({background:l.value}),onClick:u[0]||(u[0]=Z(m=>v.$emit("selected"),["stop"]))},[d("div",at,q(i.icon),1),d("div",nt,q(i.label),1)],4))}}),it=K(lt,[["__scopeId","data-v-619fdaf7"]]),rt={},ot={class:"selector"};function dt(i,a){return f(),k("div",ot,[Ve(i.$slots,"default",{},void 0,!0)])}const ut=K(rt,[["render",dt],["__scopeId","data-v-b9600c26"]]);var ct=Object.defineProperty,ht=Object.defineProperties,pt=Object.getOwnPropertyDescriptors,be=Object.getOwnPropertySymbols,vt=Object.prototype.hasOwnProperty,ft=Object.prototype.propertyIsEnumerable,ke=(i,a,l)=>a in i?ct(i,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):i[a]=l,_e=(i,a)=>{for(var l in a||(a={}))vt.call(a,l)&&ke(i,l,a[l]);if(be)for(var l of be(a))ft.call(a,l)&&ke(i,l,a[l]);return i},we=(i,a)=>ht(i,pt(a)),C=(i,a,l)=>new Promise((v,u)=>{var m=n=>{try{P(l.next(n))}catch(h){u(h)}},_=n=>{try{P(l.throw(n))}catch(h){u(h)}},P=n=>n.done?v(n.value):Promise.resolve(n.value).then(m,_);P((l=l.apply(i,a)).next())});const ee=i=>(Ze("data-v-96cc8bfd"),i=i(),Ke(),i),mt=ee(()=>d("h1",null,"Add expressions",-1)),gt={key:0,class:"page"},yt={class:"expression_list_wrapper"},bt=["onClick"],kt={class:"options_wrapper"},_t={class:"image"},wt=["width","height"],Pt=["value"],Ct=ee(()=>d("th",null,"X:",-1)),Dt=ee(()=>d("th",null,"Y:",-1)),xt={key:0},Rt=["disabled"],It={key:1},y="https://github.com/edave64/Doki-Doki-Dialog-Generator/tree/master/public/assets/",St=Pe({__name:"index",props:{character:{type:String,required:!0},initHeadGroup:String},emits:["leave"],setup(i,{emit:a}){const l={packId:"dddg.uploads.expressions",dependencies:[],packCredits:[],characters:[],fonts:[],sprites:[],poemStyles:[],poemBackgrounds:[],backgrounds:[],colors:[]},v={},u=i,m=ze(),_=b(null),P=a,n=b(null),h=b([]),w=b(null),x=b(0),I=b(0),S=b(0),N=b(!1),L=b(!1),A=b({}),V=D(()=>m.state.content.current.characters.find(t=>t.id===u.character)),G=D(()=>Object.keys(V.value.heads).map(e=>{const s=V.value.heads[e];return{name:e,preview:s.variants[0].map(r=>Ee(r,!1)),partsFiles:v[e]||[],imagePatching:{mask:je[e],addition:Te[e]}}}));function te(){G.value.length===1&&(n.value=G.value[0])}function se(){P("leave"),n.value=null,h.value=[]}function De(){if(w.value==null)return;const t=w.value;w.value=null,t.startsWith("blob:")&&URL.revokeObjectURL(t);let e=h.value.indexOf(t);h.value.splice(e,1),e>h.value.length-1&&(e=h.value.length-1),w.value=h.value[e]||null}function W(t){const e=t.split(":");let s=e[e.length-1];const r=e.length>1?e[0].trim():"";return s=(s[0].toUpperCase()+s.slice(1).toLowerCase()).split("_").join(" "),r.startsWith("dddg.")||r===""?s:r+": "+s}const ae=D(()=>{const t=V.value;return n.value?t.heads[n.value.name].variants[0][0].hq:null}),ne=D(()=>{var t,e;if(!n.value)return null;const s=V.value.id,r=n.value.name;return(e=(t=re[s+":"+r])!=null?t:re[s])!=null?e:null}),B=b(null);function xe(t){n.value&&t.dataTransfer&&(t.dataTransfer.effectAllowed="none",Array.from(t.dataTransfer.items).find(e=>e.type.match(/^image.*$/))&&(t.dataTransfer.effectAllowed="link",B.value.show()))}function Re(){return C(this,null,function*(){let t=Ne.value,e;const s=O.value[x.value];try{e=new Be(t,Se.value)}catch(r){return}Fe(()=>C(this,null,function*(){if(F.value)return;const r=new ge(s.width,s.height);try{yield r.render(p=>C(this,null,function*(){const c={color:"",composite:"source-over",current:"buildin.transparent",filters:[],flipped:!1,scaling:He.None,variant:0};Xe.prototype.prepareData.call(e,{background:c,composite:"source-over",filters:[],id:0,lastObjId:0,lastRender:"",objects:{[t.id]:t},onTopOrder:[],order:[t.id]},m),e.prepareTransform(new DOMMatrixReadOnly),yield e.prepareRender(!p.hq),yield e.render(p.fsCtx,Ye.None,p.preview,p.hq,!1)}));const g=_.value.getContext("2d");g.clearRect(0,0,_.value.width,_.value.height),r.paintOnto(g,{x:0,y:0,w:_.value.width,h:_.value.height})}finally{e.dispose(),r.dispose()}}))})}const O=D(()=>{const t=V.value;if(!n.value)return[];const e=[];for(let s=0;s<t.styleGroups.length;++s){const r=t.styleGroups[s];for(let g=0;g<r.styles.length;++g){const p=r.styles[g];for(let c=0;c<p.poses.length;++c){const o=p.poses[c];o.compatibleHeads.includes(n.value.name)&&e.push({name:o.id,styleGroupId:s,styleId:g,poseId:c,width:o.size[0],height:o.size[1]})}}}return e}),Ie=D(()=>h.value.map(t=>[{hq:t,lq:t,sourcePack:"dddg.temp1:default"}])),Se=D(()=>{const t=O.value,e=m.state.content.current.characters.find(s=>s.id===u.character);return{id:e.id,size:[960,960],defaultScale:[.8,.8],hd:!1,heads:{"dddg.temp1:default":{variants:Ie.value,previewSize:[0,0],previewOffset:[0,0]}},styleGroups:[{id:"preview",styleComponents:[],styles:[{components:{},poses:t.map((s,r)=>{const p=e.styleGroups[s.styleGroupId].styles[s.styleId],c=p.poses[s.poseId].renderCommands.slice(0);let o=c.findIndex(U=>U.type==="head");const $=c[o],de={type:"head",offset:[$.offset[0]+I.value,$.offset[1]+S.value]};if(N.value&&n.value&&n.value.imagePatching&&n.value.imagePatching.mask!=null){const U=n.value.imagePatching.mask;c.splice(o,1),o=1,c.splice(0,0,de,{type:"image",images:[{hq:U,lq:U,sourcePack:"dddg.temp1"}],composite:"destination-in",offset:$.offset})}else c.splice(o,1,de);if(L.value&&n.value&&n.value.imagePatching&&n.value.imagePatching.addition!=null){const U=n.value.imagePatching.addition;c.splice(o+1,0,{type:"image",images:[{hq:U,lq:U,sourcePack:"dddg.temp1"}],offset:$.offset})}return we(_e({},p.poses[s.poseId]),{renderCommands:c,id:"dddg.temp1:pose"+r,compatibleHeads:["dddg.temp1:default"]})})}]}],label:"",chibi:null}}),F=b(!1),H=b(null);H.value=new st(Oe,()=>C(this,null,function*(){}));function Oe(t,e){return C(this,null,function*(){const s=yield Q(t);if(!e())return;const g=yield new ge(s.width+I.value,s.height+S.value).renderToBlob(c=>C(this,null,function*(){if(c.drawImage({image:s,x:I.value,y:S.value,w:s.width,h:s.height}),N.value&&n.value&&n.value.imagePatching&&n.value.imagePatching.mask!=null){const o=yield Q(n.value.imagePatching.mask);if(!e())return;c.drawImage({image:o,x:0,y:0,w:o.width,h:o.height,composite:"destination-in"})}if(L.value&&n.value&&n.value.imagePatching&&n.value.imagePatching.addition!=null){const o=yield Q(n.value.imagePatching.addition);if(!e())return;c.drawImage({image:o,x:0,y:0,w:o.width,h:o.height})}})),p=URL.createObjectURL(g);return A.value[p]=A.value[t],t!==p&&t.startsWith("blob:")&&URL.revokeObjectURL(t),p})}function $e(){return C(this,null,function*(){F.value=!0;const t=(yield H.value.run(h.value)).filter(o=>o),e=m.state.content.current.characters.find(o=>o.id===u.character),s=m.state.content.contentPacks.find(o=>o.packId===l.packId)||l,r=JSON.parse(JSON.stringify(s));let g=r.characters.find(o=>o.id===u.character);g||(g={id:u.character,heads:{},styleGroups:[],label:"",chibi:null,size:[960,960],defaultScale:[.8,.8],hd:!1},r.characters.push(g));let p=g.heads[n.value.name];const c=e.heads[n.value.name];p==null&&(p={previewSize:c.previewSize,previewOffset:c.previewOffset,variants:[]},g.heads[n.value.name]=p);for(const o of t){const $=yield m.dispatch("uploadUrls/add",{name:"expression_"+(A.value[o]||""),url:o});p.variants.push([{hq:$,lq:$,sourcePack:l.packId}])}yield Je(()=>C(this,null,function*(){yield m.dispatch("content/replaceContentPack",{contentPack:r,processed:!0})})),se()})}const X=b(null);function Ue(){const t=X.value;if(t.files)for(const e of t.files)le(e)}function le(t){const e=URL.createObjectURL(t);ie(t.name,e)}function Ge(){return C(this,null,function*(){const t=yield Qe.prompt("Enter the url of the image.","");if(t==null)return;const e=t.split("/").slice(-1)[0];ie(e,t)})}function ie(t,e){w.value=e,A.value[e]=t,h.value.push(e)}const je={"dddg.buildin.base.monika:straight":"assets/mask/monika-a-mask.png","dddg.buildin.base.monika:sideways":"assets/mask/monika-b-mask.png","dddg.buildin.base.natsuki:straight":"assets/mask/natsuki-a-mask.png","dddg.buildin.base.natsuki:sideways":"assets/mask/natsuki-b-mask.png","dddg.buildin.base.natsuki:turnedAway":"assets/mask/natsuki-c-mask.png","dddg.buildin.base.sayori:straight":"assets/mask/sayori-a-mask.png","dddg.buildin.base.sayori:sideways":"assets/mask/sayori-b-mask.png","dddg.buildin.base.yuri:straight":"assets/mask/yuri-a-mask.png","dddg.buildin.base.yuri:sideways":"assets/mask/yuri-b-mask.png"},Te={"dddg.buildin.base.natsuki:straight":"assets/mask/natsuki-a-add.png"},re={"dddg.buildin.base.monika:ddlc.monika":`${y}monika`,"dddg.buildin.base.natsuki:ddlc.natsuki":`${y}natsuki`,"dddg.buildin.base.sayori:ddlc.sayori":`${y}sayori`,"dddg.buildin.base.yuri:ddlc.yuri":`${y}yuri`,"dddg.buildin.amy1:ddlc.fan.amy1":`${y}classic_amy`,"dddg.buildin.amy2:ddlc.fan.amy2":`${y}amy`,"dddg.buildin.femc:ddlc.fan.femc":`${y}femc`,"dddg.buildin.femc:ddlc.fan.femc:straight_lh":`${y}femc_lh`,"dddg.buildin.femc:ddlc.fan.femc:straight_hetero":`${y}femc/hetero`,"dddg.buildin.femc:ddlc.fan.femc:straight_hetero_lh":`${y}femc_lh/hetero`,"dddg.buildin.mc_classic:ddlc.fan.mc1":`${y}classic_mc`,"dddg.buildin.mc:ddlc.fan.mc2":`${y}mc`,"dddg.buildin.mc:ddlc.fan.mc2:straight_red":`${y}mc/red`,"dddg.buildin.mc_chad:ddlc.fan.mc_chad":`${y}chad`,"dddg.buildin.mc_chad:ddlc.fan.mc_chad:straight_red":`${y}chad/red`},oe={type:"character",characterType:"",freeMove:!1,close:!1,styleGroupId:0,styleId:0,poseId:0,posePositions:{},panelId:0,id:0,x:0,y:0,rotation:0,preserveRatio:!0,ratio:1,version:1,flip:!1,onTop:!1,composite:"source-over",filters:[],linkedTo:null,skewX:0,skewY:0,enlargeWhenTalking:!1,nameboxWidth:null,scaleX:1,scaleY:1,height:0,width:0,label:null,textboxColor:null,overflow:!1},Ne=D(()=>{const t=O.value[x.value];return t==null?oe:we(_e({},oe),{characterType:u.character,width:t.width,height:t.height,poseId:x.value,x:t.width/2,y:t.height/2,posePositions:{headGroup:0,head:h.value.indexOf(w.value)},label:null,textboxColor:null,enlargeWhenTalking:!1,nameboxWidth:null,scaleX:1,scaleY:1,linkedTo:null,skewX:0,skewY:0})});return u.initHeadGroup!=null&&(n.value=G.value.find(t=>t.name===u.initHeadGroup)),te(),ue(()=>G.value,te),ue(()=>[G.value,x.value,O.value,w.value,I.value,S.value,N.value,L.value],Re),(t,e)=>(f(),k("div",{class:"wrapper",onDragenter:xe,onMouseleave:e[9]||(e[9]=s=>{var r;return(r=B.value)==null?void 0:r.hide()})},[mt,n.value?(f(),k(M,{key:1},[F.value?(f(),k("div",It,[d("h2",null," Finishing up images. "+q(Math.round(H.value.percentage*100))+"% ",1)])):(f(),k("div",gt,[d("h2",null,[T(" Upload new '"+q(W(n.value.name))+"' expressions ",1),ae.value?(f(),j(ce,{key:0,to:ae.value},{default:z(()=>[T("(Template)")]),_:1},8,["to"])):E("",!0),ne.value?(f(),j(ce,{key:1,to:ne.value},{default:z(()=>[T("(List)")]),_:1},8,["to"])):E("",!0)]),he(qe,{ref_key:"dt",ref:B,class:"drop-target",onDrop:le},{default:z(()=>[T("Drop here to add as a new expression ")]),_:1},512),d("div",yt,[d("div",{class:"expression_list",onWheelPassive:e[1]||(e[1]=(...s)=>pe(ve)&&pe(ve)(...s))},[d("button",{onClick:e[0]||(e[0]=s=>X.value.click())},[T(" Upload expression "),d("input",{type:"file",ref_key:"upload",ref:X,multiple:"",onChange:Ue},null,544)]),d("button",{onClick:Ge},"Add expression from URL"),(f(!0),k(M,null,Y(h.value,(s,r)=>(f(),k("div",{key:r,style:Ce({backgroundImage:`url('${s}')`}),class:Ae({expression_item:!0,active:w.value===s}),onClick:g=>w.value=s},null,14,bt))),128))],32),d("div",kt,[d("div",_t,[d("canvas",{ref_key:"target",ref:_,width:O.value[x.value].width,height:O.value[x.value].height},null,8,wt)]),d("div",null,[T(" Preview pose: "),J(d("select",{"onUpdate:modelValue":e[2]||(e[2]=s=>x.value=s)},[(f(!0),k(M,null,Y(O.value,(s,r)=>(f(),k("option",{key:r,value:r},q(W(s.name)),9,Pt))),128))],512),[[Me,x.value]]),he(We,{title:"Offset"},{default:z(()=>[d("table",null,[d("tr",null,[Ct,d("td",null,[J(d("input",{type:"number","onUpdate:modelValue":e[3]||(e[3]=s=>I.value=s),onKeydown:e[4]||(e[4]=Z(()=>{},["stop"]))},null,544),[[fe,I.value,void 0,{number:!0}]])]),Dt,d("td",null,[J(d("input",{type:"number","onUpdate:modelValue":e[5]||(e[5]=s=>S.value=s),onKeydown:e[6]||(e[6]=Z(()=>{},["stop"]))},null,544),[[fe,S.value,void 0,{number:!0}]])])])]),I.value!==0||S.value!==0?(f(),k("p",xt," WARNING: Offsets will be lost when saving/loading. ")):E("",!0)]),_:1}),n.value.imagePatching&&n.value.imagePatching.mask?(f(),j(me,{key:0,label:"Reduce to fit DDDG standard",modelValue:N.value,"onUpdate:modelValue":e[7]||(e[7]=s=>N.value=s)},null,8,["modelValue"])):E("",!0),n.value.imagePatching&&n.value.imagePatching.addition?(f(),j(me,{key:1,label:"Add new parts to fit DDDG standard",modelValue:L.value,"onUpdate:modelValue":e[8]||(e[8]=s=>L.value=s)},null,8,["modelValue"])):E("",!0),d("button",{disabled:w.value===null,onClick:De}," Remove this expression ",8,Rt),d("button",{onClick:$e},"Finish"),d("button",{onClick:se},"Abort")])])])]))],64)):(f(),j(ut,{key:0,label:"What kind of expression would you like to add?"},{default:z(()=>[(f(!0),k(M,null,Y(G.value,s=>(f(),j(it,{key:s.name,label:W(s.name),images:s.preview,onSelected:r=>n.value=s},null,8,["label","images","onSelected"]))),128))]),_:1}))],32))}}),$t=K(St,[["__scopeId","data-v-96cc8bfd"]]);export{$t as default};
