var Ue=Object.defineProperty;var Ie=(g,s,l)=>s in g?Ue(g,s,{enumerable:!0,configurable:!0,writable:!0,value:l}):g[s]=l;var w=(g,s,l)=>Ie(g,typeof s!="symbol"?s+"":s,l);import{J as Ge,d as fe,c as _,a as y,o as c,w as K,n as ge,b as d,t as q,p as ee,K as Se,r as f,s as S,L as Oe,M as J,N as oe,P as je,O as Le,q as Y,j as O,i as N,F as T,l as Q,h as ue,g as j,f as V,_ as ce,Q as ze,u as pe,S as he,v as Ee,C as Z,U as Ne,D as me,W as Ve,k as ve,X as qe,x as Ae,Y as Be,Z as Te,e as Fe}from"./index-D3aiIfV7.js";class He{constructor(s,l,h=4){w(this,"state",Ge({busy:!1,error:null,completed:0,fullCount:0}));w(this,"pendingData",[]);w(this,"currentlyRunning",new Set);w(this,"resolveCurrentRun",null);w(this,"rejectCurrentRun",null);w(this,"returnData",[]);w(this,"remainingDisposers",new Set);w(this,"runningDisposers",new Set);this.runner=s,this.disposer=l,this.parallel=h}run(s){return this.rejectCurrentRun&&this.reject(),s=s.slice(),this.pendingData=s,this.returnData=[],this.state.fullCount=s.length,this.state.error=null,this.state.busy=!0,this.state.completed=0,new Promise((l,h)=>{this.resolveCurrentRun=l,this.rejectCurrentRun=h,s.length>0?this.restock():this.resolve()})}get remainingCapacity(){return this.parallel-this.currentlyRunning.size-this.runningDisposers.size}restock(){for(;this.remainingCapacity>0&&this.pendingData.length>0;)this.startOne();for(;this.remainingCapacity>0&&this.remainingDisposers.size>0;)this.startDisposer()}async startOne(){const s=this.pendingData.shift(),l=this.returnData.length;if(this.returnData[l]=void 0,s==null)return;this.currentlyRunning.add(s);const h=()=>this.currentlyRunning.has(s);let v;try{v=await this.runner(s,h)}catch(A){this.reject(A)}h()?(++this.state.completed,this.returnData[l]=v,this.currentlyRunning.delete(s),this.currentlyRunning.size===0&&this.pendingData.length===0&&this.resolve()):v!==void 0&&this.remainingDisposers.add(v),this.restock()}async startDisposer(){const s=this.remainingDisposers.values().next().value;this.remainingDisposers.delete(s),this.runningDisposers.add(s);try{await this.disposer(s)}catch(l){console.error(l)}this.runningDisposers.delete(s),this.restock()}resolve(){this.state.busy=!1,this.state.completed=this.state.fullCount;const s=this.returnData,l=this.resolveCurrentRun;this.reset(),l(s)}reject(s){this.state.busy=!1,this.state.error=(s==null?void 0:s.message)??null;const l=this.returnData,h=this.rejectCurrentRun;this.reset();for(const v of l)v!==void 0&&this.remainingDisposers.add(v);h()}reset(){this.returnData=[],this.currentlyRunning=new Set,this.resolveCurrentRun=null,this.rejectCurrentRun=null}get busy(){return this.state.busy}get fullCount(){return this.state.fullCount}get completed(){return this.state.completed}get percentage(){return this.fullCount===0?0:this.completed/this.fullCount}get error(){return this.state.error}}const Me={class:"icon material-icons"},We={class:"label"},Xe=fe({__name:"expression-option",props:{icon:{},label:{},images:{}},setup(g){const s=g,l=_(()=>s.images.map(h=>`center / contain no-repeat url('${h}')`).join(","));return(h,v)=>(c(),y("div",{class:"selection",style:ge({background:l.value}),onClick:v[0]||(v[0]=K(A=>h.$emit("selected"),["stop"]))},[d("div",Me,q(h.icon),1),d("div",We,q(h.label),1)],4))}}),Je=ee(Xe,[["__scopeId","data-v-f109efe4"]]),Ye={},Qe={class:"selector"};function Ze(g,s){return c(),y("div",Qe,[Se(g.$slots,"default",{},void 0,!0)])}const Ke=ee(Ye,[["render",Ze],["__scopeId","data-v-faf758f9"]]),et={key:0,class:"page"},tt={class:"expression_list_wrapper"},at=["onClick"],st={class:"options_wrapper"},nt={class:"image"},it=["width","height"],lt=["value"],rt={key:0},dt=["disabled"],ot={key:1},m="https://github.com/edave64/Doki-Doki-Dialog-Generator/tree/master/public/assets/",ut=fe({__name:"expression-builder",props:{character:{},initHeadGroup:{}},emits:["leave"],setup(g,{emit:s}){const l=g,h=s,v={packId:"dddg.uploads.expressions",dependencies:[],packCredits:[],characters:[],fonts:[],sprites:[],poemStyles:[],poemBackgrounds:[],backgrounds:[],colors:[]},A={},I=f(null),n=f(null),k=f([]),b=f(null),C=f(0),D=f(0),x=f(0),L=f(!1),z=f(!1),B=f({}),E=_(()=>S.content.current.characters.find(t=>t.id===l.character)),G=_(()=>Object.keys(E.value.heads).map(e=>{const a=E.value.heads[e];return{name:e,preview:a.variants[0].map(r=>Oe(r,!1)),partsFiles:A[e]||[],imagePatching:{mask:Pe[e],addition:Re[e]}}}));function te(){G.value.length===1&&(n.value=G.value[0])}function ae(){h("leave"),n.value=null,k.value=[]}function ye(){if(b.value==null)return;const t=b.value;b.value=null,t.startsWith("blob:")&&URL.revokeObjectURL(t);let e=k.value.indexOf(t);k.value.splice(e,1),e>k.value.length-1&&(e=k.value.length-1),b.value=k.value[e]||null}function F(t){const e=t.split(":");let a=e[e.length-1];const r=e.length>1?e[0].trim():"";return a=(a[0].toUpperCase()+a.slice(1).toLowerCase()).split("_").join(" "),r.startsWith("dddg.")||r===""?a:r+": "+a}const se=_(()=>{const t=E.value;return n.value?t.heads[n.value.name].variants[0][0].hq:null}),ne=_(()=>{if(!n.value)return null;const t=E.value.id,e=n.value.name;return re[t+":"+e]??re[t]??null}),H=f(null);function ke(t){n.value&&t.dataTransfer&&(t.dataTransfer.effectAllowed="none",Array.from(t.dataTransfer.items).find(e=>e.type.match(/^image.*$/))&&(t.dataTransfer.effectAllowed="link",H.value.show()))}async function be(){const t=R;let e;const a=P.value[C.value];try{e=new qe(t)}catch{return}Ae(async()=>{if(M.value)return;const r=new oe(a.width,a.height);try{await r.render(async o=>{await e.prepareRender(!o.hq),await e.render(o.fsCtx,Be.None,o.preview,o.hq,!1)});const p=I.value.getContext("2d");p.clearRect(0,0,I.value.width,I.value.height),r.paintOnto(p,{x:0,y:0,w:I.value.width,h:I.value.height})}finally{e.dispose(),r.dispose()}})}const P=_(()=>{const t=E.value;if(!n.value)return[];const e=[];for(let a=0;a<t.styleGroups.length;++a){const r=t.styleGroups[a];for(let p=0;p<r.styles.length;++p){const o=r.styles[p];for(let u=0;u<o.poses.length;++u){const i=o.poses[u];i.compatibleHeads.includes(n.value.name)&&e.push({name:i.id,styleGroupId:a,styleId:p,poseId:u,width:i.size[0],height:i.size[1]})}}}return e}),we=_(()=>k.value.map(t=>[{hq:t,lq:t,sourcePack:"dddg.temp1:default"}]));_(()=>{const t=P.value,e=S.content.current.characters.find(a=>a.id===l.character);return{id:e.id,size:[960,960],defaultScale:[.8,.8],hd:!1,heads:{"dddg.temp1:default":{variants:we.value,previewSize:[0,0],previewOffset:[0,0]}},styleGroups:[{id:"preview",styleComponents:[],styles:[{components:{},poses:t.map((a,r)=>{const o=e.styleGroups[a.styleGroupId].styles[a.styleId],u=o.poses[a.poseId].renderCommands.slice(0);let i=u.findIndex(U=>U.type==="head");const $=u[i],de={type:"head",offset:[$.offset[0]+D.value,$.offset[1]+x.value]};if(L.value&&n.value&&n.value.imagePatching&&n.value.imagePatching.mask!=null){const U=n.value.imagePatching.mask;u.splice(i,1),i=1,u.splice(0,0,de,{type:"image",images:[{hq:U,lq:U,sourcePack:"dddg.temp1"}],composite:"destination-in",offset:$.offset})}else u.splice(i,1,de);if(z.value&&n.value&&n.value.imagePatching&&n.value.imagePatching.addition!=null){const U=n.value.imagePatching.addition;u.splice(i+1,0,{type:"image",images:[{hq:U,lq:U,sourcePack:"dddg.temp1"}],offset:$.offset})}return{...o.poses[a.poseId],renderCommands:u,id:"dddg.temp1:pose"+r,compatibleHeads:["dddg.temp1:default"]}})}]}],label:"",chibi:null}});const M=f(!1),W=f(null);W.value=new He(Ce,async()=>{});async function Ce(t,e){const a=await J(t);if(!e())return;const p=await new oe(a.width+D.value,a.height+x.value).renderToBlob(async u=>{if(u.drawImage({image:a,x:D.value,y:x.value,w:a.width,h:a.height}),L.value&&n.value&&n.value.imagePatching&&n.value.imagePatching.mask!=null){const i=await J(n.value.imagePatching.mask);if(!e())return;u.drawImage({image:i,x:0,y:0,w:i.width,h:i.height,composite:"destination-in"})}if(z.value&&n.value&&n.value.imagePatching&&n.value.imagePatching.addition!=null){const i=await J(n.value.imagePatching.addition);if(!e())return;u.drawImage({image:i,x:0,y:0,w:i.width,h:i.height})}}),o=URL.createObjectURL(p);return B.value[o]=B.value[t],t!==o&&t.startsWith("blob:")&&URL.revokeObjectURL(t),o}async function _e(){M.value=!0;const t=(await W.value.run(k.value)).filter(i=>i),e=S.content.current.characters.find(i=>i.id===l.character),a=S.content.contentPacks.find(i=>i.packId===v.packId)||v,r=JSON.parse(JSON.stringify(a));let p=r.characters.find(i=>i.id===l.character);p||(p={id:l.character,heads:{},styleGroups:[],label:"",chibi:null,size:[960,960],defaultScale:[.8,.8],hd:!1},r.characters.push(p));let o=p.heads[n.value.name];const u=e.heads[n.value.name];o==null&&(o={previewSize:u.previewSize,previewOffset:u.previewOffset,variants:[]},p.heads[n.value.name]=o);for(const i of t){const $=await S.uploadUrls.add("expression_"+(B.value[i]||""),i);o.variants.push([{hq:$,lq:$,sourcePack:v.packId}])}await Te(async()=>{S.content.replaceContentPack({contentPack:r,processed:!0})}),ae()}const X=f(null);function De(){const t=X.value;if(t.files)for(const e of t.files)ie(e)}function ie(t){const e=URL.createObjectURL(t);le(t.name,e)}async function xe(){const t=await Fe.prompt("Enter the url of the image.","");if(t==null)return;const e=t.split("/").slice(-1)[0];le(e,t)}function le(t,e){b.value=e,B.value[e]=t,k.value.push(e)}const Pe={"dddg.buildin.base.monika:straight":"assets/mask/monika-a-mask.png","dddg.buildin.base.monika:sideways":"assets/mask/monika-b-mask.png","dddg.buildin.base.natsuki:straight":"assets/mask/natsuki-a-mask.png","dddg.buildin.base.natsuki:sideways":"assets/mask/natsuki-b-mask.png","dddg.buildin.base.natsuki:turnedAway":"assets/mask/natsuki-c-mask.png","dddg.buildin.base.sayori:straight":"assets/mask/sayori-a-mask.png","dddg.buildin.base.sayori:sideways":"assets/mask/sayori-b-mask.png","dddg.buildin.base.yuri:straight":"assets/mask/yuri-a-mask.png","dddg.buildin.base.yuri:sideways":"assets/mask/yuri-b-mask.png"},Re={"dddg.buildin.base.natsuki:straight":"assets/mask/natsuki-a-add.png"},re={"dddg.buildin.base.monika:ddlc.monika":`${m}monika`,"dddg.buildin.base.natsuki:ddlc.natsuki":`${m}natsuki`,"dddg.buildin.base.sayori:ddlc.sayori":`${m}sayori`,"dddg.buildin.base.yuri:ddlc.yuri":`${m}yuri`,"dddg.buildin.amy1:ddlc.fan.amy1":`${m}classic_amy`,"dddg.buildin.amy2:ddlc.fan.amy2":`${m}amy`,"dddg.buildin.femc:ddlc.fan.femc":`${m}femc`,"dddg.buildin.femc:ddlc.fan.femc:straight_lh":`${m}femc_lh`,"dddg.buildin.femc:ddlc.fan.femc:straight_hetero":`${m}femc/hetero`,"dddg.buildin.femc:ddlc.fan.femc:straight_hetero_lh":`${m}femc_lh/hetero`,"dddg.buildin.mc_classic:ddlc.fan.mc1":`${m}classic_mc`,"dddg.buildin.mc:ddlc.fan.mc2":`${m}mc`,"dddg.buildin.mc:ddlc.fan.mc2:straight_red":`${m}mc/red`,"dddg.buildin.mc_chad:ddlc.fan.mc_chad":`${m}chad`,"dddg.buildin.mc_chad:ddlc.fan.mc_chad:straight_red":`${m}chad/red`},$e=new je(0),R=Le.create($e,l.character);return Y(()=>P.value[C.value],t=>{t!=null&&(R.width=t.width,R.height=t.height,R.setPart("pose",C.value),R.x=t.width/2,R.y=t.height/2,R.setPosePosition({headGroup:0,head:k.value.indexOf(b.value)}))},{immediate:!0}),l.initHeadGroup!=null&&(n.value=G.value.find(t=>t.name===l.initHeadGroup)),te(),Y(()=>G.value,te),Y(()=>[G.value,C.value,P.value,b.value,D.value,x.value,L.value,z.value],be),(t,e)=>(c(),y("div",{class:"wrapper",onDragenter:ke,onMouseleave:e[9]||(e[9]=a=>{var r;return(r=H.value)==null?void 0:r.hide()})},[e[17]||(e[17]=d("h1",null,"Add expressions",-1)),n.value?(c(),y(T,{key:1},[M.value?(c(),y("div",ot,[d("h2",null," Finishing up images. "+q(Math.round(W.value.percentage*100))+"% ",1)])):(c(),y("div",et,[d("h2",null,[j(" Upload new '"+q(F(n.value.name))+"' expressions ",1),se.value?(c(),O(ce,{key:0,to:se.value},{default:N(()=>e[10]||(e[10]=[j("(Template)")])),_:1},8,["to"])):V("",!0),ne.value?(c(),O(ce,{key:1,to:ne.value},{default:N(()=>e[11]||(e[11]=[j("(List)")])),_:1},8,["to"])):V("",!0)]),ue(ze,{ref_key:"dt",ref:H,class:"drop-target",onDrop:ie},{default:N(()=>e[12]||(e[12]=[j("Drop here to add as a new expression ")])),_:1},512),d("div",tt,[d("div",{class:"expression_list",onWheelPassive:e[1]||(e[1]=(...a)=>pe(he)&&pe(he)(...a))},[d("button",{onClick:e[0]||(e[0]=a=>X.value.click())},[e[13]||(e[13]=j(" Upload expression ")),d("input",{type:"file",ref_key:"upload",ref:X,multiple:"",onChange:De},null,544)]),d("button",{onClick:xe}," Add expression from URL "),(c(!0),y(T,null,Q(k.value,(a,r)=>(c(),y("div",{key:r,style:ge({backgroundImage:`url('${a}')`}),class:Ee({expression_item:!0,active:b.value===a}),onClick:p=>b.value=a},null,14,at))),128))],32),d("div",st,[d("div",nt,[d("canvas",{ref_key:"target",ref:I,width:P.value[C.value].width,height:P.value[C.value].height},null,8,it)]),d("div",null,[e[16]||(e[16]=j(" Preview pose: ")),Z(d("select",{"onUpdate:modelValue":e[2]||(e[2]=a=>C.value=a)},[(c(!0),y(T,null,Q(P.value,(a,r)=>(c(),y("option",{key:r,value:r},q(F(a.name)),9,lt))),128))],512),[[Ne,C.value]]),ue(Ve,{title:"Offset"},{default:N(()=>[d("table",null,[d("tbody",null,[d("tr",null,[e[14]||(e[14]=d("th",null,"X:",-1)),d("td",null,[Z(d("input",{type:"number","onUpdate:modelValue":e[3]||(e[3]=a=>D.value=a),onKeydown:e[4]||(e[4]=K(()=>{},["stop"]))},null,544),[[me,D.value,void 0,{number:!0}]])]),e[15]||(e[15]=d("th",null,"Y:",-1)),d("td",null,[Z(d("input",{type:"number","onUpdate:modelValue":e[5]||(e[5]=a=>x.value=a),onKeydown:e[6]||(e[6]=K(()=>{},["stop"]))},null,544),[[me,x.value,void 0,{number:!0}]])])])])]),D.value!==0||x.value!==0?(c(),y("p",rt," WARNING: Offsets will be lost when saving/loading. ")):V("",!0)]),_:1}),n.value.imagePatching&&n.value.imagePatching.mask?(c(),O(ve,{key:0,label:"Reduce to fit DDDG standard",modelValue:L.value,"onUpdate:modelValue":e[7]||(e[7]=a=>L.value=a)},null,8,["modelValue"])):V("",!0),n.value.imagePatching&&n.value.imagePatching.addition?(c(),O(ve,{key:1,label:"Add new parts to fit DDDG standard",modelValue:z.value,"onUpdate:modelValue":e[8]||(e[8]=a=>z.value=a)},null,8,["modelValue"])):V("",!0),d("button",{disabled:b.value===null,onClick:ye}," Remove this expression ",8,dt),d("button",{onClick:_e},"Finish"),d("button",{onClick:ae},"Abort")])])])]))],64)):(c(),O(Ke,{key:0,label:"What kind of expression would you like to add?"},{default:N(()=>[(c(!0),y(T,null,Q(G.value,a=>(c(),O(Je,{key:a.name,label:F(a.name),images:a.preview,onSelected:r=>n.value=a},null,8,["label","images","onSelected"]))),128))]),_:1}))],32))}}),ht=ee(ut,[["__scopeId","data-v-b93da565"]]);export{ht as default};
