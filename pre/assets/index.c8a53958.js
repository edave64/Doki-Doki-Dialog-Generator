import{x as A,d as O,_ as x,o as h,c as f,a as l,t as _,q as T,b as S,y as q,z as X,j as Y,D as W,A as J,L as Q,B as Z,k as K,C as U,E as j,G as ee,S as se,H as te,m as y,i as b,F as D,l as k,e as w,h as C,r as I,n as ie,w as E,I as ae,s as G,v as z,p as re,g as ne}from"./index.99661843.js";var oe=Object.defineProperty,de=(e,s,t)=>s in e?oe(e,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[s]=t,g=(e,s,t)=>(de(e,typeof s!="symbol"?s+"":s,t),t),H=(e,s,t)=>new Promise((r,a)=>{var d=o=>{try{n(t.next(o))}catch(p){a(p)}},u=o=>{try{n(t.throw(o))}catch(p){a(p)}},n=o=>o.done?r(o.value):Promise.resolve(o.value).then(d,u);n((t=t.apply(e,s)).next())});class le{constructor(s,t,r=4){this.runner=s,this.disposer=t,this.parallel=r,g(this,"state",A({busy:!1,error:null,completed:0,fullCount:0})),g(this,"pendingData",[]),g(this,"currentlyRunning",new Set),g(this,"resolveCurrentRun",null),g(this,"rejectCurrentRun",null),g(this,"returnData",[]),g(this,"remainingDisposers",new Set),g(this,"runningDisposers",new Set)}run(s){return this.rejectCurrentRun&&this.reject(),s=s.slice(),this.pendingData=s,this.returnData=[],this.state.fullCount=s.length,this.state.error=null,this.state.busy=!0,this.state.completed=0,new Promise((t,r)=>{this.resolveCurrentRun=t,this.rejectCurrentRun=r,s.length>0?this.restock():this.resolve()})}get remainingCapacity(){return this.parallel-this.currentlyRunning.size-this.runningDisposers.size}restock(){for(;this.remainingCapacity>0&&this.pendingData.length>0;)this.startOne();for(;this.remainingCapacity>0&&this.remainingDisposers.size>0;)this.startDisposer()}startOne(){return H(this,null,function*(){const s=this.pendingData.shift(),t=this.returnData.length;if(this.returnData[t]=void 0,s==null)return;this.currentlyRunning.add(s);const r=()=>this.currentlyRunning.has(s);let a;try{a=yield this.runner(s,r)}catch(d){this.reject(d)}r()?(++this.state.completed,this.returnData[t]=a,this.currentlyRunning.delete(s),this.currentlyRunning.size===0&&this.pendingData.length===0&&this.resolve()):a!==void 0&&this.remainingDisposers.add(a),this.restock()})}startDisposer(){return H(this,null,function*(){const s=this.remainingDisposers.values().next().value;this.remainingDisposers.delete(s),this.runningDisposers.add(s);try{yield this.disposer(s)}catch(t){}this.runningDisposers.delete(s),this.restock()})}resolve(){this.state.busy=!1,this.state.completed=this.state.fullCount;const s=this.returnData,t=this.resolveCurrentRun;this.reset(),t(s)}reject(s){var t;this.state.busy=!1,this.state.error=(t=s==null?void 0:s.message)!=null?t:null;const r=this.returnData,a=this.rejectCurrentRun;this.reset();for(const d of r)d!==void 0&&this.remainingDisposers.add(d);a()}reset(){this.returnData=[],this.currentlyRunning=new Set,this.resolveCurrentRun=null,this.rejectCurrentRun=null}get busy(){return this.state.busy}get fullCount(){return this.state.fullCount}get completed(){return this.state.completed}get percentage(){return this.fullCount===0?0:this.completed/this.fullCount}get error(){return this.state.error}}const ue=O({props:{icon:String,label:String,images:{default:[]}},computed:{background(){return this.images.map(e=>`center / contain no-repeat url('${e}')`).join(",")}}});const he={class:"icon material-icons"},pe={class:"label"};function ce(e,s,t,r,a,d){return h(),f("div",{class:"selection",style:T({background:e.background}),onClick:s[0]||(s[0]=S(u=>e.$emit("selected"),["stop"]))},[l("div",he,_(e.icon),1),l("div",pe,_(e.label),1)],4)}const fe=x(ue,[["render",ce],["__scopeId","data-v-9845bfb8"]]),me=O({});const ge={class:"selector"};function ye(e,s,t,r,a,d){return h(),f("div",ge,[q(e.$slots,"default",{},void 0,!0)])}const ve=x(me,[["render",ye],["__scopeId","data-v-5cd45a10"]]);var be=Object.defineProperty,ke=Object.defineProperties,we=Object.getOwnPropertyDescriptors,L=Object.getOwnPropertySymbols,Ge=Object.prototype.hasOwnProperty,Pe=Object.prototype.propertyIsEnumerable,N=(e,s,t)=>s in e?be(e,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[s]=t,F=(e,s)=>{for(var t in s||(s={}))Ge.call(s,t)&&N(e,t,s[t]);if(L)for(var t of L(s))Pe.call(s,t)&&N(e,t,s[t]);return e},M=(e,s)=>ke(e,we(s)),m=(e,s,t)=>new Promise((r,a)=>{var d=o=>{try{n(t.next(o))}catch(p){a(p)}},u=o=>{try{n(t.throw(o))}catch(p){a(p)}},n=o=>o.done?r(o.value):Promise.resolve(o.value).then(d,u);n((t=t.apply(e,s)).next())});const R={packId:"dddg.uploads.expressions",dependencies:[],packCredits:[],characters:[],fonts:[],sprites:[],poemStyles:[],poemBackgrounds:[],backgrounds:[],colors:[]},$e={"dddg.buildin.base.monika:straight":"assets/mask/monika-a-mask.png","dddg.buildin.base.monika:sideways":"assets/mask/monika-b-mask.png","dddg.buildin.base.natsuki:straight":"assets/mask/natsuki-a-mask.png","dddg.buildin.base.natsuki:sideways":"assets/mask/natsuki-b-mask.png","dddg.buildin.base.natsuki:turnedAway":"assets/mask/natsuki-c-mask.png","dddg.buildin.base.sayori:straight":"assets/mask/sayori-a-mask.png","dddg.buildin.base.sayori:sideways":"assets/mask/sayori-b-mask.png","dddg.buildin.base.yuri:straight":"assets/mask/yuri-a-mask.png","dddg.buildin.base.yuri:sideways":"assets/mask/yuri-b-mask.png"},_e={"dddg.buildin.base.natsuki:straight":"assets/mask/natsuki-a-add.png"},c="https://github.com/edave64/Doki-Doki-Dialog-Generator/tree/master/public/assets/",V={"dddg.buildin.base.monika:ddlc.monika":`${c}monika`,"dddg.buildin.base.natsuki:ddlc.natsuki":`${c}natsuki`,"dddg.buildin.base.sayori:ddlc.sayori":`${c}sayori`,"dddg.buildin.base.yuri:ddlc.yuri":`${c}yuri`,"dddg.buildin.amy1:ddlc.fan.amy1":`${c}classic_amy`,"dddg.buildin.amy2:ddlc.fan.amy2":`${c}amy`,"dddg.buildin.femc:ddlc.fan.femc":`${c}femc`,"dddg.buildin.femc:ddlc.fan.femc:straight_lh":`${c}femc_lh`,"dddg.buildin.femc:ddlc.fan.femc:straight_hetero":`${c}femc/hetero`,"dddg.buildin.femc:ddlc.fan.femc:straight_hetero_lh":`${c}femc_lh/hetero`,"dddg.buildin.mc_classic:ddlc.fan.mc1":`${c}classic_mc`,"dddg.buildin.mc:ddlc.fan.mc2":`${c}mc`,"dddg.buildin.mc:ddlc.fan.mc2:straight_red":`${c}mc/red`,"dddg.buildin.mc_chad:ddlc.fan.mc_chad":`${c}chad`,"dddg.buildin.mc_chad:ddlc.fan.mc_chad:straight_red":`${c}chad/red`},De={},Ce={type:"character",characterType:"",freeMove:!1,close:!1,styleGroupId:0,styleId:0,poseId:0,posePositions:{},panelId:0,id:0,y:0,rotation:0,preserveRatio:!0,ratio:1,opacity:100,version:1,flip:!1,onTop:!1,composite:"source-over",filters:[]},Ue=O({mixins:[X],components:{Selection:fe,Selector:ve,ToggleBox:Y,DropTarget:W,DFieldset:J,L:Q},props:{character:{type:String,required:!0},initHeadGroup:String},data:()=>({method:"upload",headGroup:null,uploadsFinished:!1,everythingBroken:!1,uploadedExpressions:[],currentUploadedExpression:null,previewPoseIdx:0,offsetX:0,offsetY:0,addMask:!1,addExtras:!1,batchRunner:null,names:{}}),created(){window.exp=this,this.batchRunner=new le(this.processExpression.bind(this),()=>m(this,null,function*(){})),this.initHeadGroup!=null&&(this.headGroup=this.availableHeadGroups.find(e=>e.name===this.initHeadGroup)),this.applySingleHeadGroup()},watch:{availableHeadGroups(){this.applySingleHeadGroup()},previewPoseIdx(){this.redraw()},previewPoses(){this.redraw()},currentUploadedExpression(){this.redraw()},offsetX(){this.redraw()},offsetY(){this.redraw()},addMask(){this.redraw()},addExtras(){this.redraw()}},methods:{applySingleHeadGroup(){this.availableHeadGroups.length===1&&(this.headGroup=this.availableHeadGroups[0])},addByUpload(){return m(this,null,function*(){const e=this.$refs.upload;if(!!e.files)for(const s of e.files)this.addByImageFile(s)})},addByImageFile(e){const s=URL.createObjectURL(e);this.addUrl(e.name,s)},addByUrl(){return m(this,null,function*(){const e=yield K.prompt("Enter the url of the image.","");if(e==null)return;const s=e.split("/").slice(-1)[0];this.addUrl(s,e)})},addUrl(e,s){this.currentUploadedExpression=s,this.names[s]=e,this.uploadedExpressions.push(s)},processExpression(e,s){return m(this,null,function*(){const t=yield U(e);if(!s())return;const a=yield new j(t.width+this.offsetX,t.height+this.offsetY).renderToBlob(u=>m(this,null,function*(){if(u.drawImage({image:t,x:this.offsetX,y:this.offsetY,w:t.width,h:t.height}),this.addMask&&this.headGroup&&this.headGroup.imagePatching&&this.headGroup.imagePatching.mask!=null){const n=yield U(this.headGroup.imagePatching.mask);if(!s())return;u.drawImage({image:n,x:0,y:0,w:n.width,h:n.height,composite:"destination-in"})}if(this.addExtras&&this.headGroup&&this.headGroup.imagePatching&&this.headGroup.imagePatching.addition!=null){const n=yield U(this.headGroup.imagePatching.addition);if(!s())return;u.drawImage({image:n,x:0,y:0,w:n.width,h:n.height})}})),d=URL.createObjectURL(a);return this.names[d]=this.names[e],e!==d&&e.startsWith("blob:")&&URL.revokeObjectURL(e),d})},redraw(){return m(this,null,function*(){if(this.uploadsFinished)return;const e=this.previewPoses[this.previewPoseIdx];let s;try{s=new ee(M(F({},Ce),{width:e.width,height:e.height,poseId:this.previewPoseIdx,x:e.width/2,posePositions:{headGroup:0,head:this.uploadedExpressions.indexOf(this.currentUploadedExpression)},label:null,textboxColor:null,enlargeWhenTalking:!1,nameboxWidth:null,zoom:1}),yield this.temporaryCharacterModel)}catch(t){return}this.$nextTick(()=>m(this,null,function*(){if(this.uploadsFinished)return;const t=new j(e.width,e.height);try{yield t.render(d=>m(this,null,function*(){yield s.render(se.None,d,!1)}));const r=this.$refs.target,a=r.getContext("2d");a.clearRect(0,0,r.width,r.height),t.paintOnto(a,{x:0,y:0,w:r.width,h:r.height})}finally{s.dispose(),t.dispose()}}))})},finishUpload(){return m(this,null,function*(){this.uploadsFinished=!0;const e=(yield this.batchRunner.run(this.uploadedExpressions)).filter(n=>n),s=this.$store.state.content.current.characters.find(n=>n.id===this.character),t=this.$store.state.content.contentPacks.find(n=>n.packId===R.packId)||R,r=JSON.parse(JSON.stringify(t));let a=r.characters.find(n=>n.id===this.character);a||(a={id:this.character,heads:{},styleGroups:[],label:"",chibi:null,size:[960,960],defaultScale:[.8,.8],hd:!1},r.characters.push(a));let d=a.heads[this.headGroup.name];const u=s.heads[this.headGroup.name];d||(d={previewSize:u.previewSize,previewOffset:u.previewOffset,variants:[]},a.heads[this.headGroup.name]=d);for(const n of e){const o=yield this.$store.dispatch("uploadUrls/add",{name:"expression_"+(this.names[n]||""),url:n});d.variants.push([{hq:o,lq:o,sourcePack:R.packId}])}yield te(()=>{this.$store.dispatch("content/replaceContentPack",{contentPack:r,processed:!0})}),this.leave()})},leave(){this.$emit("leave"),this.method=null,this.headGroup=null,this.uploadedExpressions=[]},removeUploadedExpression(){if(this.currentUploadedExpression==null)return;const e=this.currentUploadedExpression;this.currentUploadedExpression=null,e.startsWith("blob:")&&URL.revokeObjectURL(e);let s=this.uploadedExpressions.indexOf(e);this.uploadedExpressions.splice(s,1),s>this.uploadedExpressions.length-1&&(s=this.uploadedExpressions.length-1),this.currentUploadedExpression=this.uploadedExpressions[s]||null},normalizeName(e){const s=e.split(":");let t=s[s.length-1];const r=s.length>1?s[0].trim():"";return t=(t[0].toUpperCase()+t.slice(1).toLowerCase()).split("_").join(" "),r.startsWith("dddg.")||r===""?t:r+": "+t},dragEnter(e){!this.headGroup||this.method!=="upload"||!e.dataTransfer||(e.dataTransfer.effectAllowed="none",Array.from(e.dataTransfer.items).find(s=>s.type.match(/^image.*$/))&&(e.dataTransfer.effectAllowed="link",this.$refs.dt.show()))},hideDt(){this.$refs.dt&&this.$refs.dt.hide()}},computed:{characterData(){return this.$store.state.content.current.characters.find(e=>e.id===this.character)},availableHeadGroups(){const e=this.characterData;return Object.keys(e.heads).map(t=>{const r=e.heads[t];return{name:t,preview:r.variants[0].map(a=>Z(a,!1)),partsFiles:De[t]||[],imagePatching:{mask:$e[t],addition:_e[t]}}})},hasParts(){return!!this.availableHeadGroups.find(e=>e.partsFiles.length>0)},downloadLink(){const e=this.characterData;return this.headGroup?e.heads[this.headGroup.name].variants[0][0].hq:null},listLink(){var e,s;if(!this.headGroup)return null;const t=this.characterData.id,r=this.headGroup.name;return(s=(e=V[t+":"+r])!=null?e:V[t])!=null?s:null},previewPoses(){const e=this.characterData;if(!this.headGroup)return[];const s=[];for(let t=0;t<e.styleGroups.length;++t){const r=e.styleGroups[t];for(let a=0;a<r.styles.length;++a){const d=r.styles[a];for(let u=0;u<d.poses.length;++u){const n=d.poses[u];n.compatibleHeads.includes(this.headGroup.name)&&s.push({name:n.id,styleGroupId:t,styleId:a,poseId:u,width:n.size[0],height:n.size[1]})}}}return s},expressionModels(){return this.uploadedExpressions.map(e=>[{hq:e,lq:e,sourcePack:"dddg.temp1:default"}])},temporaryCharacterModel(){const e=this.previewPoses,s=this.$store.state.content.current.characters.find(a=>a.id===this.character),t=this.offsetX,r=this.offsetY;return{id:this.character,size:[960,960],defaultScale:[.8,.8],hd:!1,heads:{"dddg.temp1:default":{variants:this.expressionModels,previewSize:[0,0],previewOffset:[0,0]}},styleGroups:[{id:"preview",styleComponents:[],styles:[{components:{},poses:e.map((a,d)=>{const n=s.styleGroups[a.styleGroupId].styles[a.styleId],o=n.poses[a.poseId].renderCommands.slice(0);let p=o.findIndex(i=>i.type==="head");const v=o[p],P={type:"head",offset:[v.offset[0]+t,v.offset[1]+r]};if(this.addMask&&this.headGroup&&this.headGroup.imagePatching&&this.headGroup.imagePatching.mask!=null){const i=this.headGroup.imagePatching.mask;o.splice(p,1),p=1,o.splice(0,0,P,{type:"image",images:[{hq:i,lq:i,sourcePack:"dddg.temp1"}],composite:"destination-in",offset:v.offset})}else o.splice(p,1,P);if(this.addExtras&&this.headGroup&&this.headGroup.imagePatching&&this.headGroup.imagePatching.addition!=null){const i=this.headGroup.imagePatching.addition;o.splice(p+1,0,{type:"image",images:[{hq:i,lq:i,sourcePack:"dddg.temp1"}],offset:v.offset})}return M(F({},n.poses[a.poseId]),{renderCommands:o,id:"dddg.temp1:pose"+d,compatibleHeads:["dddg.temp1:default"]})})}]}],label:"",chibi:null}}}});const B=e=>(re("data-v-ecba61e0"),e=e(),ne(),e),Ie=B(()=>l("h1",null,"Add expressions",-1)),Ee={key:0,class:"page"},Re={class:"expression_list_wrapper"},Se=["onClick"],Oe={class:"options_wrapper"},xe={class:"image"},Be=["width","height"],je=["value"],ze=B(()=>l("th",null,"X:",-1)),He=B(()=>l("th",null,"Y:",-1)),Le={key:0},Ne=["disabled"],Fe={key:1};function Me(e,s,t,r,a,d){const u=G("selection"),n=G("selector"),o=G("l"),p=G("drop-target"),v=G("d-fieldset"),P=G("toggle-box");return h(),f("div",{class:"wrapper",onDragenter:s[16]||(s[16]=(...i)=>e.dragEnter&&e.dragEnter(...i)),onMouseleave:s[17]||(s[17]=(...i)=>e.hideDt&&e.hideDt(...i))},[Ie,e.headGroup?e.method?e.method==="upload"?(h(),f(D,{key:2},[e.uploadsFinished?(h(),f("div",Fe,[l("h2",null," Finishing up images. "+_(Math.round(e.batchRunner.percentage*100))+"% ",1)])):(h(),f("div",Ee,[l("h2",null,[k(" Upload new '"+_(e.normalizeName(e.headGroup.name))+"' expressions ",1),e.downloadLink?(h(),y(o,{key:0,to:e.downloadLink},{default:b(()=>[k("(Template)")]),_:1},8,["to"])):w("",!0),e.listLink?(h(),y(o,{key:1,to:e.listLink},{default:b(()=>[k("(List)")]),_:1},8,["to"])):w("",!0)]),C(p,{ref:"dt",class:"drop-target",onDrop:e.addByImageFile},{default:b(()=>[k("Drop here to add as a new expression ")]),_:1},8,["onDrop"]),l("div",Re,[l("div",{class:"expression_list",onWheelPassive:s[5]||(s[5]=(...i)=>e.verticalScrollRedirect&&e.verticalScrollRedirect(...i))},[l("button",{onClick:s[3]||(s[3]=i=>e.$refs.upload.click())},[k(" Upload expression "),l("input",{type:"file",ref:"upload",multiple:"",onChange:s[2]||(s[2]=(...i)=>e.addByUpload&&e.addByUpload(...i))},null,544)]),l("button",{onClick:s[4]||(s[4]=(...i)=>e.addByUrl&&e.addByUrl(...i))},"Add expression from URL"),(h(!0),f(D,null,I(e.uploadedExpressions,(i,$)=>(h(),f("div",{key:$,style:T({backgroundImage:`url('${i}')`}),class:ie({expression_item:!0,active:e.currentUploadedExpression===i}),onClick:Ve=>e.currentUploadedExpression=i},null,14,Se))),128))],32),l("div",Oe,[l("div",xe,[l("canvas",{ref:"target",width:e.previewPoses[e.previewPoseIdx].width,height:e.previewPoses[e.previewPoseIdx].height},null,8,Be)]),l("div",null,[k(" Preview pose: "),E(l("select",{"onUpdate:modelValue":s[6]||(s[6]=i=>e.previewPoseIdx=i)},[(h(!0),f(D,null,I(e.previewPoses,(i,$)=>(h(),f("option",{key:$,value:$},_(e.normalizeName(i.name)),9,je))),128))],512),[[ae,e.previewPoseIdx]]),C(v,{title:"Offset"},{default:b(()=>[l("table",null,[l("tr",null,[ze,l("td",null,[E(l("input",{type:"number","onUpdate:modelValue":s[7]||(s[7]=i=>e.offsetX=i),onKeydown:s[8]||(s[8]=S(()=>{},["stop"]))},null,544),[[z,e.offsetX,void 0,{number:!0}]])]),He,l("td",null,[E(l("input",{type:"number","onUpdate:modelValue":s[9]||(s[9]=i=>e.offsetY=i),onKeydown:s[10]||(s[10]=S(()=>{},["stop"]))},null,544),[[z,e.offsetY,void 0,{number:!0}]])])])]),e.offsetX!==0||e.offsetY!==0?(h(),f("p",Le," WARNING: Offsets will be lost when saving/loading. ")):w("",!0)]),_:1}),e.headGroup.imagePatching&&e.headGroup.imagePatching.mask?(h(),y(P,{key:0,label:"Reduce to fit DDDG standard",modelValue:e.addMask,"onUpdate:modelValue":s[11]||(s[11]=i=>e.addMask=i)},null,8,["modelValue"])):w("",!0),e.headGroup.imagePatching&&e.headGroup.imagePatching.addition?(h(),y(P,{key:1,label:"Add new parts to fit DDDG standard",modelValue:e.addExtras,"onUpdate:modelValue":s[12]||(s[12]=i=>e.addExtras=i)},null,8,["modelValue"])):w("",!0),l("button",{disabled:e.currentUploadedExpression===null,onClick:s[13]||(s[13]=(...i)=>e.removeUploadedExpression&&e.removeUploadedExpression(...i))}," Remove this expression ",8,Ne),l("button",{onClick:s[14]||(s[14]=(...i)=>e.finishUpload&&e.finishUpload(...i))},"Finish"),l("button",{onClick:s[15]||(s[15]=(...i)=>e.leave&&e.leave(...i))},"Abort")])])])]))],64)):w("",!0):(h(),y(n,{key:1,label:"How would you like to add the new expressions?"},{default:b(()=>[C(u,{label:"Build expressions from parts",icon:"info",disabled:e.hasParts,onSelected:s[0]||(s[0]=i=>e.method="parts")},null,8,["disabled"]),C(u,{label:"Upload expression images",icon:"info",onSelected:s[1]||(s[1]=i=>e.method="upload")})]),_:1})):(h(),y(n,{key:0,label:"What kind of expression would you like to add?"},{default:b(()=>[(h(!0),f(D,null,I(e.availableHeadGroups,i=>(h(),y(u,{key:i.name,label:e.normalizeName(i.name),images:i.preview,onSelected:$=>e.headGroup=i},null,8,["label","images","onSelected"]))),128))]),_:1}))],32)}const Ae=x(Ue,[["render",Me],["__scopeId","data-v-ecba61e0"]]);export{Ae as default};
