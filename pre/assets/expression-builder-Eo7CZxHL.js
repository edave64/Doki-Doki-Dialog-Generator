var Ue=Object.defineProperty;var Se=(g,a,l)=>a in g?Ue(g,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):g[a]=l;var w=(g,a,l)=>Se(g,typeof a!="symbol"?a+"":a,l);import{J as Ge,d as ve,c as C,a as y,o as p,w as J,n as fe,b as o,t as E,q as Q,K as Oe,u as Te,r as f,L as je,M as H,N as re,s as oe,k as G,j as N,F as A,m as X,i as de,g as O,f as z,_ as ue,O as Le,h as ce,P as pe,v as Ne,C as Y,Q as ze,D as he,S as Ee,l as me,U as Ve,x as Ae,W as Me,X as qe,Y as Be,Z as We,e as Fe}from"./index-p3EhkaQw.js";class He{constructor(a,l,m=4){w(this,"state",Ge({busy:!1,error:null,completed:0,fullCount:0}));w(this,"pendingData",[]);w(this,"currentlyRunning",new Set);w(this,"resolveCurrentRun",null);w(this,"rejectCurrentRun",null);w(this,"returnData",[]);w(this,"remainingDisposers",new Set);w(this,"runningDisposers",new Set);this.runner=a,this.disposer=l,this.parallel=m}run(a){return this.rejectCurrentRun&&this.reject(),a=a.slice(),this.pendingData=a,this.returnData=[],this.state.fullCount=a.length,this.state.error=null,this.state.busy=!0,this.state.completed=0,new Promise((l,m)=>{this.resolveCurrentRun=l,this.rejectCurrentRun=m,a.length>0?this.restock():this.resolve()})}get remainingCapacity(){return this.parallel-this.currentlyRunning.size-this.runningDisposers.size}restock(){for(;this.remainingCapacity>0&&this.pendingData.length>0;)this.startOne();for(;this.remainingCapacity>0&&this.remainingDisposers.size>0;)this.startDisposer()}async startOne(){const a=this.pendingData.shift(),l=this.returnData.length;if(this.returnData[l]=void 0,a==null)return;this.currentlyRunning.add(a);const m=()=>this.currentlyRunning.has(a);let c;try{c=await this.runner(a,m)}catch($){this.reject($)}m()?(++this.state.completed,this.returnData[l]=c,this.currentlyRunning.delete(a),this.currentlyRunning.size===0&&this.pendingData.length===0&&this.resolve()):c!==void 0&&this.remainingDisposers.add(c),this.restock()}async startDisposer(){const a=this.remainingDisposers.values().next().value;this.remainingDisposers.delete(a),this.runningDisposers.add(a);try{await this.disposer(a)}catch(l){console.error(l)}this.runningDisposers.delete(a),this.restock()}resolve(){this.state.busy=!1,this.state.completed=this.state.fullCount;const a=this.returnData,l=this.resolveCurrentRun;this.reset(),l(a)}reject(a){this.state.busy=!1,this.state.error=(a==null?void 0:a.message)??null;const l=this.returnData,m=this.rejectCurrentRun;this.reset();for(const c of l)c!==void 0&&this.remainingDisposers.add(c);m()}reset(){this.returnData=[],this.currentlyRunning=new Set,this.resolveCurrentRun=null,this.rejectCurrentRun=null}get busy(){return this.state.busy}get fullCount(){return this.state.fullCount}get completed(){return this.state.completed}get percentage(){return this.fullCount===0?0:this.completed/this.fullCount}get error(){return this.state.error}}const Xe={class:"icon material-icons"},Ye={class:"label"},Je=ve({__name:"expression-option",props:{icon:{},label:{},images:{}},setup(g){const a=g,l=C(()=>a.images.map(m=>`center / contain no-repeat url('${m}')`).join(","));return(m,c)=>(p(),y("div",{class:"selection",style:fe({background:l.value}),onClick:c[0]||(c[0]=J($=>m.$emit("selected"),["stop"]))},[o("div",Xe,E(m.icon),1),o("div",Ye,E(m.label),1)],4))}}),Qe=Q(Je,[["__scopeId","data-v-f109efe4"]]),Ze={},Ke={class:"selector"};function et(g,a){return p(),y("div",Ke,[Oe(g.$slots,"default",{},void 0,!0)])}const tt=Q(Ze,[["render",et],["__scopeId","data-v-faf758f9"]]),st={key:0,class:"page"},at={class:"expression_list_wrapper"},nt=["onClick"],it={class:"options_wrapper"},lt={class:"image"},rt=["width","height"],ot=["value"],dt={key:0},ut=["disabled"],ct={key:1},v="https://github.com/edave64/Doki-Doki-Dialog-Generator/tree/master/public/assets/",pt=ve({__name:"expression-builder",props:{character:{},initHeadGroup:{}},emits:["leave"],setup(g,{emit:a}){const l=g,m=a,c=Te(),$={packId:"dddg.uploads.expressions",dependencies:[],packCredits:[],characters:[],fonts:[],sprites:[],poemStyles:[],poemBackgrounds:[],backgrounds:[],colors:[]},ge={},U=f(null),n=f(null),k=f([]),b=f(null),x=f(0),D=f(0),_=f(0),T=f(!1),j=f(!1),V=f({}),L=C(()=>c.state.content.current.characters.find(t=>t.id===l.character)),S=C(()=>Object.keys(L.value.heads).map(e=>{const s=L.value.heads[e];return{name:e,preview:s.variants[0].map(r=>je(r,!1)),partsFiles:ge[e]||[],imagePatching:{mask:Pe[e],addition:Ie[e]}}}));function Z(){S.value.length===1&&(n.value=S.value[0])}function K(){m("leave"),n.value=null,k.value=[]}function ye(){if(b.value==null)return;const t=b.value;b.value=null,t.startsWith("blob:")&&URL.revokeObjectURL(t);let e=k.value.indexOf(t);k.value.splice(e,1),e>k.value.length-1&&(e=k.value.length-1),b.value=k.value[e]||null}function M(t){const e=t.split(":");let s=e[e.length-1];const r=e.length>1?e[0].trim():"";return s=(s[0].toUpperCase()+s.slice(1).toLowerCase()).split("_").join(" "),r.startsWith("dddg.")||r===""?s:r+": "+s}const ee=C(()=>{const t=L.value;return n.value?t.heads[n.value.name].variants[0][0].hq:null}),te=C(()=>{if(!n.value)return null;const t=L.value.id,e=n.value.name;return ne[t+":"+e]??ne[t]??null}),q=f(null);function ke(t){n.value&&t.dataTransfer&&(t.dataTransfer.effectAllowed="none",Array.from(t.dataTransfer.items).find(e=>e.type.match(/^image.*$/))&&(t.dataTransfer.effectAllowed="link",q.value.show()))}async function be(){const t=$e.value;let e;const s=R.value[x.value];try{e=new Ve(t,Ce.value)}catch{return}Ae(async()=>{if(B.value)return;const r=new re(s.width,s.height);try{await r.render(async u=>{const d={color:"",composite:"source-over",current:"buildin.transparent",filters:[],flipped:!1,scaling:Me.None,variant:0};qe.prototype.prepareData.call(e,{background:d,composite:"source-over",filters:[],id:0,lastObjId:0,lastRender:"",objects:{[t.id]:t},onTopOrder:[],order:[t.id]},c),e.prepareTransform(new DOMMatrixReadOnly),await e.prepareRender(!u.hq),await e.render(u.fsCtx,Be.None,u.preview,u.hq,!1)});const h=U.value.getContext("2d");h.clearRect(0,0,U.value.width,U.value.height),r.paintOnto(h,{x:0,y:0,w:U.value.width,h:U.value.height})}finally{e.dispose(),r.dispose()}})}const R=C(()=>{const t=L.value;if(!n.value)return[];const e=[];for(let s=0;s<t.styleGroups.length;++s){const r=t.styleGroups[s];for(let h=0;h<r.styles.length;++h){const u=r.styles[h];for(let d=0;d<u.poses.length;++d){const i=u.poses[d];i.compatibleHeads.includes(n.value.name)&&e.push({name:i.id,styleGroupId:s,styleId:h,poseId:d,width:i.size[0],height:i.size[1]})}}}return e}),we=C(()=>k.value.map(t=>[{hq:t,lq:t,sourcePack:"dddg.temp1:default"}])),Ce=C(()=>{const t=R.value,e=c.state.content.current.characters.find(s=>s.id===l.character);return{id:e.id,size:[960,960],defaultScale:[.8,.8],hd:!1,heads:{"dddg.temp1:default":{variants:we.value,previewSize:[0,0],previewOffset:[0,0]}},styleGroups:[{id:"preview",styleComponents:[],styles:[{components:{},poses:t.map((s,r)=>{const u=e.styleGroups[s.styleGroupId].styles[s.styleId],d=u.poses[s.poseId].renderCommands.slice(0);let i=d.findIndex(I=>I.type==="head");const P=d[i],le={type:"head",offset:[P.offset[0]+D.value,P.offset[1]+_.value]};if(T.value&&n.value&&n.value.imagePatching&&n.value.imagePatching.mask!=null){const I=n.value.imagePatching.mask;d.splice(i,1),i=1,d.splice(0,0,le,{type:"image",images:[{hq:I,lq:I,sourcePack:"dddg.temp1"}],composite:"destination-in",offset:P.offset})}else d.splice(i,1,le);if(j.value&&n.value&&n.value.imagePatching&&n.value.imagePatching.addition!=null){const I=n.value.imagePatching.addition;d.splice(i+1,0,{type:"image",images:[{hq:I,lq:I,sourcePack:"dddg.temp1"}],offset:P.offset})}return{...u.poses[s.poseId],renderCommands:d,id:"dddg.temp1:pose"+r,compatibleHeads:["dddg.temp1:default"]}})}]}],label:"",chibi:null}}),B=f(!1),W=f(null);W.value=new He(xe,async()=>{});async function xe(t,e){const s=await H(t);if(!e())return;const h=await new re(s.width+D.value,s.height+_.value).renderToBlob(async d=>{if(d.drawImage({image:s,x:D.value,y:_.value,w:s.width,h:s.height}),T.value&&n.value&&n.value.imagePatching&&n.value.imagePatching.mask!=null){const i=await H(n.value.imagePatching.mask);if(!e())return;d.drawImage({image:i,x:0,y:0,w:i.width,h:i.height,composite:"destination-in"})}if(j.value&&n.value&&n.value.imagePatching&&n.value.imagePatching.addition!=null){const i=await H(n.value.imagePatching.addition);if(!e())return;d.drawImage({image:i,x:0,y:0,w:i.width,h:i.height})}}),u=URL.createObjectURL(h);return V.value[u]=V.value[t],t!==u&&t.startsWith("blob:")&&URL.revokeObjectURL(t),u}async function De(){B.value=!0;const t=(await W.value.run(k.value)).filter(i=>i),e=c.state.content.current.characters.find(i=>i.id===l.character),s=c.state.content.contentPacks.find(i=>i.packId===$.packId)||$,r=JSON.parse(JSON.stringify(s));let h=r.characters.find(i=>i.id===l.character);h||(h={id:l.character,heads:{},styleGroups:[],label:"",chibi:null,size:[960,960],defaultScale:[.8,.8],hd:!1},r.characters.push(h));let u=h.heads[n.value.name];const d=e.heads[n.value.name];u==null&&(u={previewSize:d.previewSize,previewOffset:d.previewOffset,variants:[]},h.heads[n.value.name]=u);for(const i of t){const P=await c.dispatch("uploadUrls/add",{name:"expression_"+(V.value[i]||""),url:i});u.variants.push([{hq:P,lq:P,sourcePack:$.packId}])}await We(async()=>{await c.dispatch("content/replaceContentPack",{contentPack:r,processed:!0})}),K()}const F=f(null);function _e(){const t=F.value;if(t.files)for(const e of t.files)se(e)}function se(t){const e=URL.createObjectURL(t);ae(t.name,e)}async function Re(){const t=await Fe.prompt("Enter the url of the image.","");if(t==null)return;const e=t.split("/").slice(-1)[0];ae(e,t)}function ae(t,e){b.value=e,V.value[e]=t,k.value.push(e)}const Pe={"dddg.buildin.base.monika:straight":"assets/mask/monika-a-mask.png","dddg.buildin.base.monika:sideways":"assets/mask/monika-b-mask.png","dddg.buildin.base.natsuki:straight":"assets/mask/natsuki-a-mask.png","dddg.buildin.base.natsuki:sideways":"assets/mask/natsuki-b-mask.png","dddg.buildin.base.natsuki:turnedAway":"assets/mask/natsuki-c-mask.png","dddg.buildin.base.sayori:straight":"assets/mask/sayori-a-mask.png","dddg.buildin.base.sayori:sideways":"assets/mask/sayori-b-mask.png","dddg.buildin.base.yuri:straight":"assets/mask/yuri-a-mask.png","dddg.buildin.base.yuri:sideways":"assets/mask/yuri-b-mask.png"},Ie={"dddg.buildin.base.natsuki:straight":"assets/mask/natsuki-a-add.png"},ne={"dddg.buildin.base.monika:ddlc.monika":`${v}monika`,"dddg.buildin.base.natsuki:ddlc.natsuki":`${v}natsuki`,"dddg.buildin.base.sayori:ddlc.sayori":`${v}sayori`,"dddg.buildin.base.yuri:ddlc.yuri":`${v}yuri`,"dddg.buildin.amy1:ddlc.fan.amy1":`${v}classic_amy`,"dddg.buildin.amy2:ddlc.fan.amy2":`${v}amy`,"dddg.buildin.femc:ddlc.fan.femc":`${v}femc`,"dddg.buildin.femc:ddlc.fan.femc:straight_lh":`${v}femc_lh`,"dddg.buildin.femc:ddlc.fan.femc:straight_hetero":`${v}femc/hetero`,"dddg.buildin.femc:ddlc.fan.femc:straight_hetero_lh":`${v}femc_lh/hetero`,"dddg.buildin.mc_classic:ddlc.fan.mc1":`${v}classic_mc`,"dddg.buildin.mc:ddlc.fan.mc2":`${v}mc`,"dddg.buildin.mc:ddlc.fan.mc2:straight_red":`${v}mc/red`,"dddg.buildin.mc_chad:ddlc.fan.mc_chad":`${v}chad`,"dddg.buildin.mc_chad:ddlc.fan.mc_chad:straight_red":`${v}chad/red`},ie={type:"character",characterType:"",freeMove:!1,close:!1,styleGroupId:0,styleId:0,poseId:0,posePositions:{},panelId:0,id:0,x:0,y:0,rotation:0,preserveRatio:!0,ratio:1,version:1,flip:!1,onTop:!1,composite:"source-over",filters:[],linkedTo:null,skewX:0,skewY:0,enlargeWhenTalking:!1,nameboxWidth:null,scaleX:1,scaleY:1,height:0,width:0,label:null,textboxColor:null,overflow:!1},$e=C(()=>{const t=R.value[x.value];return t==null?ie:{...ie,characterType:l.character,width:t.width,height:t.height,poseId:x.value,x:t.width/2,y:t.height/2,posePositions:{headGroup:0,head:k.value.indexOf(b.value)},label:null,textboxColor:null,enlargeWhenTalking:!1,nameboxWidth:null,scaleX:1,scaleY:1,linkedTo:null,skewX:0,skewY:0}});return l.initHeadGroup!=null&&(n.value=S.value.find(t=>t.name===l.initHeadGroup)),Z(),oe(()=>S.value,Z),oe(()=>[S.value,x.value,R.value,b.value,D.value,_.value,T.value,j.value],be),(t,e)=>(p(),y("div",{class:"wrapper",onDragenter:ke,onMouseleave:e[9]||(e[9]=s=>{var r;return(r=q.value)==null?void 0:r.hide()})},[e[17]||(e[17]=o("h1",null,"Add expressions",-1)),n.value?(p(),y(A,{key:1},[B.value?(p(),y("div",ct,[o("h2",null," Finishing up images. "+E(Math.round(W.value.percentage*100))+"% ",1)])):(p(),y("div",st,[o("h2",null,[O(" Upload new '"+E(M(n.value.name))+"' expressions ",1),ee.value?(p(),G(ue,{key:0,to:ee.value},{default:N(()=>e[10]||(e[10]=[O("(Template)")])),_:1},8,["to"])):z("",!0),te.value?(p(),G(ue,{key:1,to:te.value},{default:N(()=>e[11]||(e[11]=[O("(List)")])),_:1},8,["to"])):z("",!0)]),de(Le,{ref_key:"dt",ref:q,class:"drop-target",onDrop:se},{default:N(()=>e[12]||(e[12]=[O("Drop here to add as a new expression ")])),_:1},512),o("div",at,[o("div",{class:"expression_list",onWheelPassive:e[1]||(e[1]=(...s)=>ce(pe)&&ce(pe)(...s))},[o("button",{onClick:e[0]||(e[0]=s=>F.value.click())},[e[13]||(e[13]=O(" Upload expression ")),o("input",{type:"file",ref_key:"upload",ref:F,multiple:"",onChange:_e},null,544)]),o("button",{onClick:Re}," Add expression from URL "),(p(!0),y(A,null,X(k.value,(s,r)=>(p(),y("div",{key:r,style:fe({backgroundImage:`url('${s}')`}),class:Ne({expression_item:!0,active:b.value===s}),onClick:h=>b.value=s},null,14,nt))),128))],32),o("div",it,[o("div",lt,[o("canvas",{ref_key:"target",ref:U,width:R.value[x.value].width,height:R.value[x.value].height},null,8,rt)]),o("div",null,[e[16]||(e[16]=O(" Preview pose: ")),Y(o("select",{"onUpdate:modelValue":e[2]||(e[2]=s=>x.value=s)},[(p(!0),y(A,null,X(R.value,(s,r)=>(p(),y("option",{key:r,value:r},E(M(s.name)),9,ot))),128))],512),[[ze,x.value]]),de(Ee,{title:"Offset"},{default:N(()=>[o("table",null,[o("tbody",null,[o("tr",null,[e[14]||(e[14]=o("th",null,"X:",-1)),o("td",null,[Y(o("input",{type:"number","onUpdate:modelValue":e[3]||(e[3]=s=>D.value=s),onKeydown:e[4]||(e[4]=J(()=>{},["stop"]))},null,544),[[he,D.value,void 0,{number:!0}]])]),e[15]||(e[15]=o("th",null,"Y:",-1)),o("td",null,[Y(o("input",{type:"number","onUpdate:modelValue":e[5]||(e[5]=s=>_.value=s),onKeydown:e[6]||(e[6]=J(()=>{},["stop"]))},null,544),[[he,_.value,void 0,{number:!0}]])])])])]),D.value!==0||_.value!==0?(p(),y("p",dt," WARNING: Offsets will be lost when saving/loading. ")):z("",!0)]),_:1}),n.value.imagePatching&&n.value.imagePatching.mask?(p(),G(me,{key:0,label:"Reduce to fit DDDG standard",modelValue:T.value,"onUpdate:modelValue":e[7]||(e[7]=s=>T.value=s)},null,8,["modelValue"])):z("",!0),n.value.imagePatching&&n.value.imagePatching.addition?(p(),G(me,{key:1,label:"Add new parts to fit DDDG standard",modelValue:j.value,"onUpdate:modelValue":e[8]||(e[8]=s=>j.value=s)},null,8,["modelValue"])):z("",!0),o("button",{disabled:b.value===null,onClick:ye}," Remove this expression ",8,ut),o("button",{onClick:De},"Finish"),o("button",{onClick:K},"Abort")])])])]))],64)):(p(),G(tt,{key:0,label:"What kind of expression would you like to add?"},{default:N(()=>[(p(!0),y(A,null,X(S.value,s=>(p(),G(Qe,{key:s.name,label:M(s.name),images:s.preview,onSelected:r=>n.value=s},null,8,["label","images","onSelected"]))),128))]),_:1}))],32))}}),vt=Q(pt,[["__scopeId","data-v-30cda7f6"]]);export{vt as default};
